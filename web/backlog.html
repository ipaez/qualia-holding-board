<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qualia Holding Board — Backlog</title>
<script src="shared.js"></script>
<style id="shared-css"></style>
<style>
.top-bar {
  display: flex; justify-content: space-between; align-items: center;
  padding: 20px 28px 0; gap: 16px; flex-wrap: wrap;
}
.top-bar h1 {
  font-family: var(--font-heading); font-size: 1.3rem; font-weight: 700;
  color: var(--text-primary); letter-spacing: -0.3px;
}
.top-bar h1 span { color: var(--gold); }
.top-stats { display: flex; gap: 8px; flex-wrap: wrap; }
.stat-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 5px 14px; border-radius: var(--radius-pill);
  background: var(--bg-card); border: 1px solid var(--border);
  font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-secondary);
}
.stat-badge .dot { width: 7px; height: 7px; border-radius: 50%; }

.filters {
  display: flex; gap: 10px; padding: 14px 28px; flex-wrap: wrap; align-items: center;
}
.filters select, .filters input {
  background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border);
  padding: 8px 12px; border-radius: var(--radius-sm); font-size: 0.85rem;
  font-family: var(--font-body); transition: border-color .2s; cursor: pointer;
}
.filters input { flex: 1; min-width: 180px; cursor: text; }
.filters select:focus, .filters input:focus { outline: none; border-color: var(--gold); }

.group-toggles {
  display: flex; gap: 4px; padding: 0 28px 14px;
}
.group-btn {
  padding: 5px 14px; border-radius: var(--radius-pill); border: 1px solid var(--border);
  background: transparent; color: var(--text-tertiary); cursor: pointer;
  font-family: var(--font-body); font-size: 0.78rem; font-weight: 500; transition: all .2s;
}
.group-btn:hover { border-color: var(--border-hover); color: var(--text-secondary); }
.group-btn.active { background: var(--gold-dim); border-color: var(--gold); color: var(--gold); }

.backlog-list { padding: 0 28px 28px; }
.group-header {
  font-family: var(--font-heading); font-size: 0.65rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 2px; color: var(--text-tertiary);
  padding: 20px 0 10px; border-bottom: 1px solid var(--border); margin-bottom: 4px;
  display: flex; align-items: center; gap: 10px;
}
.group-count {
  font-family: var(--font-mono); font-size: 0.68rem; background: var(--bg-card);
  padding: 2px 8px; border-radius: var(--radius-pill); color: var(--text-tertiary);
}

.task-row {
  display: grid; grid-template-columns: 36px 1fr 140px 100px 80px 60px;
  gap: 10px; align-items: center; padding: 10px 12px; border-radius: 8px;
  transition: background .15s; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.02);
}
.task-row:hover { background: var(--bg-card-hover); }

.status-indicator {
  width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center; cursor: pointer;
  transition: all .2s; flex-shrink: 0;
}
.status-indicator:hover { border-color: var(--gold); }
.status-indicator.idea { border-color: var(--text-tertiary); }
.status-indicator.ready { border-color: var(--gold); background: var(--gold-dim); }
.status-indicator.ready::after { content: '▸'; color: var(--gold); font-size: 0.8rem; font-weight: 700; }
.status-indicator.in-progress { border-color: var(--cyan); background: rgba(6,214,214,0.1); border-style: dashed; animation: spin 3s linear infinite; }
.status-indicator.in-progress::after { content: '◦'; color: var(--cyan); font-size: 1rem; }
.status-indicator.blocked { border-color: var(--red); background: rgba(248,113,113,0.1); }
.status-indicator.blocked::after { content: '!'; color: var(--red); font-size: 0.75rem; font-weight: 700; }
.status-indicator.done { background: var(--green); border-color: var(--green); }
.status-indicator.done::after { content: '✓'; color: #fff; font-size: 0.75rem; font-weight: 700; }
@keyframes spin { to { transform: rotate(360deg); } }

.task-title {
  font-size: 0.88rem; font-weight: 500; color: var(--text-primary);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.task-row.done-row .task-title { text-decoration: line-through; color: var(--text-tertiary); }

.task-project {
  font-size: 0.75rem; font-weight: 600; padding: 3px 10px;
  border-radius: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.task-agent {
  font-family: var(--font-mono); font-size: 0.72rem; color: var(--text-tertiary);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.task-priority { display: flex; align-items: center; justify-content: center; }
.task-type {
  font-size: 0.65rem; color: var(--text-tertiary); font-family: var(--font-heading);
  text-transform: uppercase; letter-spacing: 1px; font-weight: 600; text-align: center;
}

.empty-state {
  text-align: center; padding: 60px 20px; color: var(--text-tertiary);
  font-size: 0.9rem;
}

@media (max-width: 900px) {
  .task-row { grid-template-columns: 36px 1fr 100px 80px; }
  .task-type, .task-priority { display: none; }
}
@media (max-width: 600px) {
  .task-row { grid-template-columns: 36px 1fr 80px; }
  .task-project { display: none; }
  .filters { padding: 10px 16px; }
  .top-bar, .group-toggles, .backlog-list { padding-left: 16px; padding-right: 16px; }
}
</style>
</head>
<body>
<script>document.getElementById('shared-css').textContent = getSharedCSS();</script>
<script>document.write(getNavHTML('backlog'));</script>
<div class="qb-main">

<div class="top-bar">
  <h1><span>◈</span> Backlog Unificado</h1>
  <div class="top-stats" id="topStats"></div>
</div>

<div class="filters">
  <select id="filterAgent"><option value="">Todos los agentes</option></select>
  <select id="filterProject"><option value="">Todos los proyectos</option></select>
  <select id="filterStatus">
    <option value="">Todos los estados</option>
    <option value="idea">Idea</option>
    <option value="ready">Ready</option>
    <option value="in-progress">En progreso</option>
    <option value="blocked">Bloqueada</option>
    <option value="done">Done</option>
  </select>
  <select id="filterPriority">
    <option value="">Todas las prioridades</option>
    <option value="high">Alta</option>
    <option value="medium">Media</option>
    <option value="low">Baja</option>
  </select>
  <input type="text" id="searchInput" placeholder="Buscar tareas...">
</div>

<div class="group-toggles">
  <button class="group-btn active" data-group="none">Sin agrupar</button>
  <button class="group-btn" data-group="agent">Por agente</button>
  <button class="group-btn" data-group="project">Por proyecto</button>
  <button class="group-btn" data-group="status">Por estado</button>
</div>

<div class="backlog-list" id="backlogList"></div>

<script>document.write(getModalHTML());</script>

<script>
let tasks = [], projects = [], agents = [];
let groupBy = 'none';

const STATUS_LABELS = { 'idea': 'Idea', 'ready': 'Ready', 'in-progress': 'En progreso', 'blocked': 'Bloqueada', 'done': 'Completada' };
const STATUS_ORDER = { 'in-progress': 0, 'blocked': 1, 'ready': 2, 'idea': 3, 'done': 4 };

let _refreshing = false;
async function refresh() {
  if (_refreshing) return;
  _refreshing = true;
  try {
    const data = await loadData();
    tasks = data.tasks; projects = data.projects; agents = data.agents;
    populateFilters();
    populateModalSelects(projects, agents);
    render();
  } finally { _refreshing = false; }
}

function populateFilters() {
  const fp = document.getElementById('filterProject');
  const fa = document.getElementById('filterAgent');
  const val1 = fp.value, val2 = fa.value;
  fp.innerHTML = '<option value="">Todos los proyectos</option>';
  fa.innerHTML = '<option value="">Todos los agentes</option>';
  projects.forEach(p => { const o = document.createElement('option'); o.value = p; o.textContent = p; fp.appendChild(o); });
  agents.forEach(a => { const o = document.createElement('option'); o.value = a; o.textContent = a; fa.appendChild(o); });
  fp.value = val1; fa.value = val2;
}

function getFiltered() {
  let list = [...tasks];
  const agent = document.getElementById('filterAgent').value;
  const project = document.getElementById('filterProject').value;
  const status = document.getElementById('filterStatus').value;
  const priority = document.getElementById('filterPriority').value;
  const search = document.getElementById('searchInput').value.toLowerCase();
  if (agent) list = list.filter(t => t.agent === agent);
  if (project) list = list.filter(t => t.project === project);
  if (status) list = list.filter(t => t.status === status);
  if (priority) list = list.filter(t => t.priority === priority);
  if (search) list = list.filter(t => t.title.toLowerCase().includes(search) || (t.description||'').toLowerCase().includes(search));
  list.sort((a, b) => (STATUS_ORDER[a.status] ?? 3) - (STATUS_ORDER[b.status] ?? 3));
  return list;
}

function renderRow(t) {
  const pc = getProjectColor(t.project);
  const pcBg = pc + '18';
  return `
  <div class="task-row ${t.status === 'done' ? 'done-row' : ''} ${projClass(t.project)}" data-id="${t.id}">
    <div class="status-indicator ${t.status}" onclick="event.stopPropagation(); cycleStatus('${t.id}')" title="${STATUS_LABELS[t.status] || t.status}"></div>
    <div class="task-title" title="${esc(t.title)}">${esc(t.title)}</div>
    <div class="task-project" style="background:${pcBg};color:${pc}">${esc(t.project)}</div>
    <div class="task-agent">${esc(t.agent)}</div>
    <div class="task-priority"><span class="priority-dot ${t.priority}"></span></div>
    <div class="task-type">${esc(t.type)}</div>
  </div>`;
}

function render() {
  const list = getFiltered();
  const el = document.getElementById('backlogList');

  // Stats
  const stats = {};
  for (const t of tasks) stats[t.status] = (stats[t.status] || 0) + 1;
  const colors = { 'in-progress': 'var(--cyan)', 'blocked': 'var(--red)', 'idea': 'var(--text-tertiary)', 'ready': 'var(--gold)', 'done': 'var(--green)' };
  document.getElementById('topStats').innerHTML = Object.entries(stats)
    .sort(([a],[b]) => (STATUS_ORDER[a]??3) - (STATUS_ORDER[b]??3))
    .map(([s, n]) => `<div class="stat-badge"><div class="dot" style="background:${colors[s]||'#666'}"></div>${STATUS_LABELS[s]||s}: ${n}</div>`).join('');

  if (list.length === 0) {
    el.innerHTML = '<div class="empty-state">No se encontraron tareas con estos filtros.</div>';
    return;
  }

  if (groupBy === 'none') {
    el.innerHTML = list.map(renderRow).join('');
  } else {
    const groups = {};
    for (const t of list) {
      const key = t[groupBy] || 'Sin asignar';
      if (!groups[key]) groups[key] = [];
      groups[key].push(t);
    }
    let html = '';
    for (const [key, items] of Object.entries(groups).sort((a,b) => a[0].localeCompare(b[0]))) {
      html += `<div class="group-header">${esc(groupBy === 'status' ? (STATUS_LABELS[key]||key) : key)} <span class="group-count">${items.length}</span></div>`;
      html += items.map(renderRow).join('');
    }
    el.innerHTML = html;
  }

  // Click handlers for rows
  el.querySelectorAll('.task-row').forEach(row => {
    row.addEventListener('click', () => {
      const t = tasks.find(x => x.id === row.dataset.id);
      if (t) openEditModal(t);
    });
  });
}

const STATUS_CYCLE = ['idea', 'ready', 'in-progress', 'blocked', 'done'];
let _undoTimer = null;

async function cycleStatus(id) {
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  const prevStatus = t.status;
  const idx = STATUS_CYCLE.indexOf(t.status);
  const next = STATUS_CYCLE[(idx + 1) % STATUS_CYCLE.length];

  // Optimistic update: update local state and re-render immediately
  t.status = next;
  render();
  showUndoToast(id, t.title, prevStatus, next);

  // Then persist to API (no refresh needed - next auto-refresh will confirm)
  await fetch(`${API}/tasks/${id}/move`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: next })
  });
}

function showUndoToast(taskId, title, prevStatus, newStatus) {
  // Remove existing toast
  const old = document.querySelector('.undo-toast');
  if (old) old.remove();
  clearTimeout(_undoTimer);

  const short = title.length > 40 ? title.substring(0, 40) + '...' : title;
  const label = STATUS_LABELS[newStatus] || newStatus;
  const toast = document.createElement('div');
  toast.className = 'undo-toast';
  const doneMsg = newStatus === 'done' ? ' (movida a Completadas)' : '';
  toast.innerHTML = `<span>"${esc(short)}" → <strong>${label}</strong>${doneMsg}</span><button onclick="undoStatus('${taskId}','${prevStatus}')">Deshacer</button>`;
  document.body.appendChild(toast);

  _undoTimer = setTimeout(() => {
    toast.classList.add('hiding');
    setTimeout(() => toast.remove(), 200);
  }, 5000);
}

async function undoStatus(taskId, prevStatus) {
  clearTimeout(_undoTimer);
  const toast = document.querySelector('.undo-toast');
  if (toast) toast.remove();

  // Optimistic update
  const t = tasks.find(x => x.id === taskId);
  if (t) { t.status = prevStatus; render(); }

  await fetch(`${API}/tasks/${taskId}/move`, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: prevStatus })
  });
}

// Group toggle buttons
document.querySelectorAll('.group-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.group-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    groupBy = btn.dataset.group;
    render();
  });
});

// Filter listeners
['filterAgent','filterProject','filterStatus','filterPriority'].forEach(id => {
  document.getElementById(id).addEventListener('change', render);
});
document.getElementById('searchInput').addEventListener('input', render);

// Modal listeners
initModalListeners();
document.querySelector('.btn-save').addEventListener('click', () => saveTask(refresh));
document.querySelector('.btn-cancel').addEventListener('click', closeModal);
document.getElementById('btnDelete').addEventListener('click', () => deleteTask(refresh));

// Init
initSidebar();
refresh();
setInterval(refresh, 5000);
</script>
</div>
</body>
</html>
